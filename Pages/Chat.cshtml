@* @page
@model SemanticBotStar.Pages.ChatModel
@{
} *@

@page
@model SemanticBotStar.Pages.ChatModel
@{
    ViewData["Title"] = "Ask Star SemanticBot";
}

<link rel="stylesheet" href="~/css/chat.css" />

<div class="container mt-4" style="max-width: 1100px;">
    <h4 class="mb-2">Ask Star SemanticBot</h4>
    <p class="text-muted mb-4">
        Engage with your documents using natural language queries to retrieve instant answers and insights.
    </p>

    <div class="row">
        <!-- Chat Section -->
        <div class="col-md-8">
            <div id="chatBox" class="border rounded p-3 mb-3"
                 style="height: 380px; overflow-y: auto; background-color: #f9f9f9;">
                <!-- Chat messages will appear here -->
            </div>

            <!-- Input Section -->
            <div class="d-flex gap-2">
                <input id="userInput" type="text" class="form-control" placeholder="Type your question here..." />
                <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()">Send</button>
                <button class="btn btn-secondary" onclick="clearChat()">Clear Chat</button>
            </div>
        </div>

        <!-- Right: References / Citations -->
        <div class="col-md-4">
            <div class="border rounded p-3" style="height: 380px; overflow-y: auto; background-color: #fcfcfc;">
                <h5 class="text-center mb-3">Referenced Documents</h5>
                <ul id="referenceList" class="list-group small">
                    <!-- References will be added here dynamically -->
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatBox = document.getElementById("chatBox");
        const userInput = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const referenceList = document.getElementById("referenceList");

        // Send message on Enter key
        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const question = userInput.value.trim();
            if (!question) return;

            appendMessage("user", question);
            userInput.value = "";
            sendBtn.disabled = true;
            sendBtn.innerText = "Thinking...";

            try {
                const res = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                const data = await res.json();
                const answer = data.answer || data.Answer || "No response.";
                const refs = data.references || data.citations || [];

                appendMessage("bot", answer);
                updateReferences(refs);
            } catch (error) {
                appendMessage("bot", "⚠️ Sorry, there was an error getting the response.");
            }

            sendBtn.disabled = false;
            sendBtn.innerText = "Send";
        }

        function appendMessage(sender, text) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("mb-3", "p-2", "rounded");

            if (sender === "user") {
                msgDiv.classList.add("bg-primary", "text-white");
                msgDiv.style.textAlign = "right";
                msgDiv.innerHTML = `<strong>You:</strong> ${text}`;
            } else {
                msgDiv.classList.add("bg-light");
                msgDiv.innerHTML = `<strong>Star SemanticBot:</strong> ${text}`;
            }

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updateReferences(refs) {
            referenceList.innerHTML = "";
            if (!refs || refs.length === 0) {
                referenceList.innerHTML = "<li class='list-group-item text-muted'>No references available.</li>";
                return;
            }

            refs.forEach((ref, index) => {
                const li = document.createElement("li");
                li.classList.add("list-group-item");
                li.innerHTML = `
                    <strong>${index + 1}.</strong> ${ref.title || ref.name || "Untitled"}
                    <br><small class="text-muted">${ref.source || ""}</small>
                `;
                referenceList.appendChild(li);
            });
        }

        function clearChat() {
            chatBox.innerHTML = "";
            referenceList.innerHTML = "";
        }
    </script>
}
